<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X vs O Betting - Timer bilan</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .rules {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .timer-section {
            background: linear-gradient(135deg, #2c3e50, #4a235a);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .timer-display {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        
        .timer-phase {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #f39c12;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #f1c40f);
            transition: width 1s linear;
        }
        
        .login-section {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .game-status {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .teams-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .team {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .team-x {
            border: 2px solid #3498db;
        }
        
        .team-o {
            border: 2px solid #e74c3c;
        }
        
        .team-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .total-amount {
            font-size: 1.8rem;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .bets-count {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .bet-form {
            margin-top: 15px;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        input {
            background-color: rgba(255, 255, 255, 0.9);
        }
        
        button {
            background-color: #2ecc71;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }
        
        button:hover:not(:disabled) {
            background-color: #27ae60;
        }
        
        .recent-bets {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .recent-bets h2 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .bet-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .bet-item:last-child {
            border-bottom: none;
        }
        
        .bet-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .won {
            background-color: #2ecc71;
        }
        
        .lost {
            background-color: #e74c3c;
        }
        
        .pending {
            background-color: #f39c12;
        }
        
        .winner-section {
            text-align: center;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .winner-amount {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
            color: #2ecc71;
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .game-controls button {
            flex: 1;
            max-width: 200px;
        }
        
        .reset-btn {
            background-color: #e74c3c;
        }
        
        .reset-btn:hover {
            background-color: #c0392b;
        }
        
        .online-users {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .online-users h3 {
            margin-bottom: 10px;
            text-align: center;
        }
        
        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .user-badge {
            background-color: #3498db;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        @media (max-width: 600px) {
            .teams-container {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .timer-display {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>X vs O Betting - Timer bilan</h1>
            <div class="rules">
                <p><strong>Qoidalar:</strong> Pastroq summa to'plagan g'olib - G'oliblar 2X pul yutadi - Teng bo'lsa Admin yutadi</p>
                <p><strong>Vaqt:</strong> 3 daqiqa betting + 30 soniya tanaffus</p>
            </div>
            
            <div class="timer-section">
                <div class="timer-phase" id="timerPhase">Betting davomiyligi</div>
                <div class="timer-display" id="timerDisplay">03:00</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 100%"></div>
                </div>
                <div id="nextRoundInfo">Keyingi raund: <span id="nextRoundTime">00:30</span> dan keyin</div>
            </div>
            
            <div id="loginSection" class="login-section">
                <h3>O'yinchi nomingizni kiriting</h3>
                <input type="text" id="playerName" placeholder="Ismingiz" value="Player">
                <button onclick="login()">O'yinga kirish</button>
            </div>
            <div class="game-status" id="gameStatus">O'yin davom etmoqda</div>
        </header>
        
        <div id="gameContent" style="display: none;">
            <div class="teams-container">
                <div class="team team-x">
                    <h2 class="team-title">Team X</h2>
                    <div class="total-amount" id="teamXTotal">0 UZS</div>
                    <div class="bets-count" id="teamXBets">0 bets</div>
                    <div class="bet-form">
                        <input type="number" id="xBetAmount" placeholder="Bet miqdori (UZS)" min="100" value="1000">
                        <button id="betXButton" onclick="placeBet('X')">Team X ga bet qo'yish</button>
                    </div>
                </div>
                
                <div class="team team-o">
                    <h2 class="team-title">Team O</h2>
                    <div class="total-amount" id="teamOTotal">0 UZS</div>
                    <div class="bets-count" id="teamOBets">0 bets</div>
                    <div class="bet-form">
                        <input type="number" id="oBetAmount" placeholder="Bet miqdori (UZS)" min="100" value="1000">
                        <button id="betOButton" onclick="placeBet('O')">Team O ga bet qo'yish</button>
                    </div>
                </div>
            </div>
            
            <div class="recent-bets">
                <h2>Oxirgi betlar</h2>
                <div id="recentBetsList">
                    <!-- Betlar ro'yxati -->
                </div>
            </div>
            
            <div class="online-users">
                <h3>Onlayn o'yinchilar</h3>
                <div class="user-list" id="userList">
                    <!-- O'yinchilar ro'yxati -->
                </div>
            </div>
            
            <div class="winner-section" id="winnerSection" style="display: none;">
                <h2>G'olib</h2>
                <div id="winnerName"></div>
                <div class="winner-amount" id="winnerAmount"></div>
            </div>
            
            <div class="game-controls">
                <button id="manualEndButton" onclick="endGame()" style="display: none;">O'yinni tugatish</button>
                <button class="reset-btn" onclick="resetGame()">Yangi o'yin</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase konfiguratsiyasi - O'zgartirishingiz kerak
        const firebaseConfig = {
            apiKey: "AIzaSyEXAMPLE1234567890abcdefghijklmnopq",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef123456"
        };

        // Firebase ni ishga tushirish
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Timer sozlamalari
        const BETTING_TIME = 3 * 60; // 3 daqiqa (180 soniya)
        const BREAK_TIME = 30; // 30 soniya tanaffus
        let currentTime = BETTING_TIME;
        let isBettingPhase = true;
        let timerInterval = null;

        let currentPlayer = "";
        let playerId = "";

        // Timer ni boshlash
        function startTimer() {
            // Firebase dan timer ma'lumotlarini olish
            database.ref('timer').on('value', (snapshot) => {
                const timerData = snapshot.val();
                if (timerData) {
                    currentTime = timerData.currentTime;
                    isBettingPhase = timerData.isBettingPhase;
                    updateTimerDisplay();
                }
            });

            // Har soniya timer ni yangilash
            timerInterval = setInterval(() => {
                currentTime--;
                
                if (currentTime <= 0) {
                    // Vaqt tugadi
                    if (isBettingPhase) {
                        // Betting vaqti tugadi, o'yinni tugatish
                        endGame();
                        // Tanaffus boshlanishi
                        currentTime = BREAK_TIME;
                        isBettingPhase = false;
                    } else {
                        // Tanaffus tugadi, yangi raund boshlanishi
                        startNewRound();
                    }
                }
                
                // Firebase ga yangi vaqtni saqlash
                database.ref('timer').set({
                    currentTime: currentTime,
                    isBettingPhase: isBettingPhase
                });
                
                updateTimerDisplay();
            }, 1000);
        }

        // Timer displeyni yangilash
        function updateTimerDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            const timerDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timerDisplay').textContent = timerDisplay;
            document.getElementById('timerPhase').textContent = isBettingPhase ? 
                'Betting davomiyligi' : 'Tanaffus';
            
            // Progress bar ni yangilash
            const totalTime = isBettingPhase ? BETTING_TIME : BREAK_TIME;
            const progressPercent = (currentTime / totalTime) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            
            // Keyingi raund vaqtini ko'rsatish
            if (!isBettingPhase) {
                document.getElementById('nextRoundInfo').style.display = 'block';
                document.getElementById('nextRoundTime').textContent = timerDisplay;
            } else {
                document.getElementById('nextRoundInfo').style.display = 'none';
            }
            
            // Bet tugmalarini faollashtirish/faolsizlashtirish
            const betButtons = [document.getElementById('betXButton'), document.getElementById('betOButton')];
            betButtons.forEach(button => {
                button.disabled = !isBettingPhase;
            });
        }

        // Yangi raund boshlash
        function startNewRound() {
            currentTime = BETTING_TIME;
            isBettingPhase = true;
            
            // O'yinni qayta boshlash
            resetGame();
            
            // Firebase ga yangi vaqtni saqlash
            database.ref('timer').set({
                currentTime: currentTime,
                isBettingPhase: isBettingPhase
            });
        }

        // O'yinchi nomini kiritish
        function login() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Iltimos, ismingizni kiriting!');
                return;
            }
            
            currentPlayer = playerName;
            playerId = Date.now().toString();
            
            // Firebase ga o'yinchi qo'shish
            database.ref('players/' + playerId).set({
                name: playerName,
                online: true,
                lastActive: Date.now()
            });
            
            // UI ni yangilash
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('gameContent').style.display = 'block';
            
            // Timer va o'yin ma'lumotlarini yuklash
            startTimer();
            loadGameData();
        }

        // O'yin ma'lumotlarini yuklash
        function loadGameData() {
            // Team X ma'lumotlari
            database.ref('teamX').on('value', (snapshot) => {
                const data = snapshot.val() || { total: 0, bets: 0 };
                document.getElementById('teamXTotal').textContent = formatCurrency(data.total) + ' UZS';
                document.getElementById('teamXBets').textContent = data.bets + ' bets';
            });

            // Team O ma'lumotlari
            database.ref('teamO').on('value', (snapshot) => {
                const data = snapshot.val() || { total: 0, bets: 0 };
                document.getElementById('teamOTotal').textContent = formatCurrency(data.total) + ' UZS';
                document.getElementById('teamOBets').textContent = data.bets + ' bets';
            });

            // Betlar ro'yxati
            database.ref('bets').limitToLast(10).on('value', (snapshot) => {
                const betsList = document.getElementById('recentBetsList');
                betsList.innerHTML = '';
                
                const bets = snapshot.val() || {};
                Object.values(bets).reverse().forEach(bet => {
                    const betItem = document.createElement('div');
                    betItem.className = 'bet-item';
                    
                    const statusClass = bet.status === 'Won' ? 'won' : 
                                      bet.status === 'Lost' ? 'lost' : 'pending';
                    
                    betItem.innerHTML = `
                        <div>
                            <strong>${bet.player}</strong><br>
                            ${formatCurrency(bet.amount)} UZS
                        </div>
                        <div>
                            <span class="bet-status ${statusClass}">${bet.status}</span><br>
                            Team ${bet.team}
                        </div>
                    `;
                    
                    betsList.appendChild(betItem);
                });
            });

            // Onlayn o'yinchilar
            database.ref('players').on('value', (snapshot) => {
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                
                const players = snapshot.val() || {};
                Object.values(players).forEach(player => {
                    if (player.online) {
                        const userBadge = document.createElement('div');
                        userBadge.className = 'user-badge';
                        userBadge.textContent = player.name;
                        userList.appendChild(userBadge);
                    }
                });
            });

            // O'yin holati
            database.ref('gameState').on('value', (snapshot) => {
                const gameState = snapshot.val() || { ended: false, winner: null };
                
                if (gameState.ended) {
                    document.getElementById('gameStatus').textContent = 'O\'yin tugadi';
                    document.getElementById('gameStatus').style.backgroundColor = 'rgba(231, 76, 60, 0.3)';
                    
                    if (gameState.winner) {
                        document.getElementById('winnerSection').style.display = 'block';
                        document.getElementById('winnerName').textContent = gameState.winner === 'Owner' ? 'Admin' : 'Team ' + gameState.winner;
                        document.getElementById('winnerAmount').textContent = 'Yutdi: ' + formatCurrency(gameState.winAmount) + ' UZS';
                    }
                } else {
                    document.getElementById('gameStatus').textContent = 'O\'yin davom etmoqda';
                    document.getElementById('gameStatus').style.backgroundColor = 'rgba(46, 204, 113, 0.3)';
                    document.getElementById('winnerSection').style.display = 'none';
                }
            });
        }

        // Bet qo'yish
        function placeBet(team) {
            if (!isBettingPhase) {
                alert('Betting vaqti tugadi! Keyingi raundni kuting.');
                return;
            }
            
            const amountField = team === 'X' ? document.getElementById('xBetAmount') : document.getElementById('oBetAmount');
            const amount = parseInt(amountField.value);
            
            if (isNaN(amount) || amount < 100) {
                alert('Iltimos, to\'g\'ri miqdor kiriting (minimum 100 UZS)!');
                return;
            }
            
            // Firebase ga bet qo'shish
            const betId = Date.now().toString();
            database.ref('bets/' + betId).set({
                player: currentPlayer,
                amount: amount,
                team: team,
                status: 'Pending',
                timestamp: Date.now()
            });
            
            // Team summasini yangilash
            const teamRef = team === 'X' ? 'teamX' : 'teamO';
            database.ref(teamRef).transaction(current => {
                if (current) {
                    return {
                        total: current.total + amount,
                        bets: current.bets + 1
                    };
                } else {
                    return {
                        total: amount,
                        bets: 1
                    };
                }
            });
            
            amountField.value = '1000';
        }

        // O'yinni tugatish
        function endGame() {
            database.ref('gameState').once('value').then((snapshot) => {
                if (snapshot.val() && snapshot.val().ended) {
                    return;
                }
                
                database.ref('teamX').once('value').then((teamXSnapshot) => {
                    database.ref('teamO').once('value').then((teamOSnapshot) => {
                        const teamX = teamXSnapshot.val() || { total: 0 };
                        const teamO = teamOSnapshot.val() || { total: 0 };
                        
                        let winner, winAmount;
                        
                        if (teamX.total < teamO.total) {
                            winner = 'X';
                            winAmount = teamX.total * 2;
                        } else if (teamO.total < teamX.total) {
                            winner = 'O';
                            winAmount = teamO.total * 2;
                        } else {
                            winner = 'Owner';
                            winAmount = teamX.total + teamO.total;
                        }
                        
                        // G'olibni saqlash
                        database.ref('gameState').set({
                            ended: true,
                            winner: winner,
                            winAmount: winAmount
                        });
                        
                        // Betlarni yangilash
                        database.ref('bets').once('value').then((betsSnapshot) => {
                            const bets = betsSnapshot.val() || {};
                            Object.keys(bets).forEach(betId => {
                                const bet = bets[betId];
                                let status = 'Lost';
                                
                                if (winner === 'Owner') {
                                    status = 'Lost';
                                } else if (bet.team === winner) {
                                    status = 'Won';
                                }
                                
                                database.ref('bets/' + betId + '/status').set(status);
                            });
                        });
                    });
                });
            });
        }

        // Yangi o'yin
        function resetGame() {
            database.ref('teamX').set({
                total: 0,
                bets: 0
            });
            
            database.ref('teamO').set({
                total: 0,
                bets: 0
            });
            
            database.ref('bets').remove();
            
            database.ref('gameState').set({
                ended: false,
                winner: null,
                winAmount: 0
            });
        }

        // Pul formati
        function formatCurrency(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // O'yinchi chiqayotganda
        window.addEventListener('beforeunload', () => {
            if (playerId) {
                database.ref('players/' + playerId).update({
                    online: false,
                    lastActive: Date.now()
                });
            }
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        });

        // Dastlabki timer sozlamalari
        database.ref('timer').once('value').then((snapshot) => {
            if (!snapshot.exists()) {
                database.ref('timer').set({
                    currentTime: BETTING_TIME,
                    isBettingPhase: true
                });
            }
        });
    </script>
</body>
</html>
