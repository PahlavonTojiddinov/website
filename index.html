<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X vs O Betting - Bitta Timer</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* CSS kodlari oldingidek */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML kodlari oldingidek -->
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyEXAMPLE1234567890abcdefghijklmnopq",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef123456"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const BETTING_TIME = 3 * 60;
        const BREAK_TIME = 30;
        let currentTime = BETTING_TIME;
        let isBettingPhase = true;
        let currentPlayer = "";
        let playerId = "";

        // Timer ni boshlash - FAQAT BIRINCHI FOYDALANUVCHI
        function startTimer() {
            // Timer holatini kuzatish
            database.ref('timer').on('value', (snapshot) => {
                const timerData = snapshot.val();
                if (timerData) {
                    currentTime = timerData.currentTime;
                    isBettingPhase = timerData.isBettingPhase;
                    updateTimerDisplay();
                }
            });

            // Server timer ishlamayotgan bo'lsa, ishga tushirish
            database.ref('timer/isRunning').once('value').then((snapshot) => {
                if (!snapshot.exists() || !snapshot.val()) {
                    // Timer ishlamayapti, yangi timer ishga tushirish
                    startServerTimer();
                }
            });
        }

        // Server timerini ishga tushirish
        function startServerTimer() {
            console.log("Yangi timer ishga tushirildi");
            
            // Timer holatini yangilash
            database.ref('timer').set({
                currentTime: BETTING_TIME,
                isBettingPhase: true,
                isRunning: true,
                lastUpdated: Date.now(),
                startedBy: currentPlayer
            });

            // Server tomondagi timer
            const updateTimer = () => {
                database.ref('timer').once('value').then((snapshot) => {
                    const timerData = snapshot.val();
                    if (timerData && timerData.isRunning) {
                        let newTime = timerData.currentTime - 1;
                        let newPhase = timerData.isBettingPhase;

                        if (newTime <= 0) {
                            if (timerData.isBettingPhase) {
                                // Betting vaqti tugadi
                                endGame();
                                newTime = BREAK_TIME;
                                newPhase = false;
                            } else {
                                // Tanaffus tugadi
                                startNewRound();
                                newTime = BETTING_TIME;
                                newPhase = true;
                            }
                        }

                        // Yangi vaqtni saqlash
                        database.ref('timer').update({
                            currentTime: newTime,
                            isBettingPhase: newPhase,
                            lastUpdated: Date.now()
                        });

                        // Keyingi yangilanishni rejalashtirish
                        setTimeout(updateTimer, 1000);
                    }
                });
            };

            // Timer ni boshlash
            setTimeout(updateTimer, 1000);
        }

        // O'yinchi nomini kiritish
        function login() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Iltimos, ismingizni kiriting!');
                return;
            }
            
            currentPlayer = playerName;
            playerId = Date.now().toString();
            
            // Firebase ga o'yinchi qo'shish
            database.ref('players/' + playerId).set({
                name: playerName,
                online: true,
                lastActive: Date.now()
            });
            
            // UI ni yangilash
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('gameContent').style.display = 'block';
            
            // Timer va o'yin ma'lumotlarini yuklash
            startTimer();
            loadGameData();
        }

        // Timer displeyni yangilash
        function updateTimerDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            const timerDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timerDisplay').textContent = timerDisplay;
            document.getElementById('timerPhase').textContent = isBettingPhase ? 
                'Betting davomiyligi' : 'Tanaffus';
            
            // Progress bar
            const totalTime = isBettingPhase ? BETTING_TIME : BREAK_TIME;
            const progressPercent = (currentTime / totalTime) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            
            // Keyingi raund vaqti
            if (!isBettingPhase) {
                document.getElementById('nextRoundInfo').style.display = 'block';
                document.getElementById('nextRoundTime').textContent = timerDisplay;
            } else {
                document.getElementById('nextRoundInfo').style.display = 'none';
            }
            
            // Bet tugmalarini faollashtirish/faolsizlashtirish
            const betButtons = [document.getElementById('betXButton'), document.getElementById('betOButton')];
            betButtons.forEach(button => {
                button.disabled = !isBettingPhase;
            });
        }

        // Yangi raund boshlash
        function startNewRound() {
            // O'yinni qayta boshlash
            resetGame();
        }

        // O'yin ma'lumotlarini yuklash
        function loadGameData() {
            // Team X ma'lumotlari
            database.ref('teamX').on('value', (snapshot) => {
                const data = snapshot.val() || { total: 0, bets: 0 };
                document.getElementById('teamXTotal').textContent = formatCurrency(data.total) + ' UZS';
                document.getElementById('teamXBets').textContent = data.bets + ' bets';
            });

            // Team O ma'lumotlari
            database.ref('teamO').on('value', (snapshot) => {
                const data = snapshot.val() || { total: 0, bets: 0 };
                document.getElementById('teamOTotal').textContent = formatCurrency(data.total) + ' UZS';
                document.getElementById('teamOBets').textContent = data.bets + ' bets';
            });

            // Betlar ro'yxati
            database.ref('bets').limitToLast(10).on('value', (snapshot) => {
                const betsList = document.getElementById('recentBetsList');
                betsList.innerHTML = '';
                
                const bets = snapshot.val() || {};
                Object.values(bets).reverse().forEach(bet => {
                    const betItem = document.createElement('div');
                    betItem.className = 'bet-item';
                    
                    const statusClass = bet.status === 'Won' ? 'won' : 
                                      bet.status === 'Lost' ? 'lost' : 'pending';
                    
                    betItem.innerHTML = `
                        <div>
                            <strong>${bet.player}</strong><br>
                            ${formatCurrency(bet.amount)} UZS
                        </div>
                        <div>
                            <span class="bet-status ${statusClass}">${bet.status}</span><br>
                            Team ${bet.team}
                        </div>
                    `;
                    
                    betsList.appendChild(betItem);
                });
            });

            // O'yin holati
            database.ref('gameState').on('value', (snapshot) => {
                const gameState = snapshot.val() || { ended: false, winner: null };
                
                if (gameState.ended) {
                    document.getElementById('gameStatus').textContent = 'O\'yin tugadi';
                    document.getElementById('gameStatus').style.backgroundColor = 'rgba(231, 76, 60, 0.3)';
                    
                    if (gameState.winner) {
                        document.getElementById('winnerSection').style.display = 'block';
                        document.getElementById('winnerName').textContent = gameState.winner === 'Owner' ? 'Admin' : 'Team ' + gameState.winner;
                        document.getElementById('winnerAmount').textContent = 'Yutdi: ' + formatCurrency(gameState.winAmount) + ' UZS';
                    }
                } else {
                    document.getElementById('gameStatus').textContent = 'O\'yin davom etmoqda';
                    document.getElementById('gameStatus').style.backgroundColor = 'rgba(46, 204, 113, 0.3)';
                    document.getElementById('winnerSection').style.display = 'none';
                }
            });
        }

        // Bet qo'yish
        function placeBet(team) {
            if (!isBettingPhase) {
                alert('Betting vaqti tugadi! Keyingi raundni kuting.');
                return;
            }
            
            const amountField = team === 'X' ? document.getElementById('xBetAmount') : document.getElementById('oBetAmount');
            const amount = parseInt(amountField.value);
            
            if (isNaN(amount) || amount < 100) {
                alert('Iltimos, to\'g\'ri miqdor kiriting (minimum 100 UZS)!');
                return;
            }
            
            // Firebase ga bet qo'shish
            const betId = Date.now().toString();
            database.ref('bets/' + betId).set({
                player: currentPlayer,
                amount: amount,
                team: team,
                status: 'Pending',
                timestamp: Date.now()
            });
            
            // Team summasini yangilash
            const teamRef = team === 'X' ? 'teamX' : 'teamO';
            database.ref(teamRef).transaction(current => {
                if (current) {
                    return {
                        total: current.total + amount,
                        bets: current.bets + 1
                    };
                } else {
                    return {
                        total: amount,
                        bets: 1
                    };
                }
            });
            
            amountField.value = '1000';
        }

        // O'yinni tugatish
        function endGame() {
            database.ref('teamX').once('value').then((teamXSnapshot) => {
                database.ref('teamO').once('value').then((teamOSnapshot) => {
                    const teamX = teamXSnapshot.val() || { total: 0 };
                    const teamO = teamOSnapshot.val() || { total: 0 };
                    
                    let winner, winAmount;
                    
                    if (teamX.total < teamO.total) {
                        winner = 'X';
                        winAmount = teamX.total * 2;
                    } else if (teamO.total < teamX.total) {
                        winner = 'O';
                        winAmount = teamO.total * 2;
                    } else {
                        winner = 'Owner';
                        winAmount = teamX.total + teamO.total;
                    }
                    
                    // G'olibni saqlash
                    database.ref('gameState').set({
                        ended: true,
                        winner: winner,
                        winAmount: winAmount
                    });
                    
                    // Betlarni yangilash
                    database.ref('bets').once('value').then((betsSnapshot) => {
                        const bets = betsSnapshot.val() || {};
                        Object.keys(bets).forEach(betId => {
                            const bet = bets[betId];
                            let status = 'Lost';
                            
                            if (winner === 'Owner') {
                                status = 'Lost';
                            } else if (bet.team === winner) {
                                status = 'Won';
                            }
                            
                            database.ref('bets/' + betId + '/status').set(status);
                        });
                    });
                });
            });
        }

        // Yangi o'yin
        function resetGame() {
            database.ref('teamX').set({
                total: 0,
                bets: 0
            });
            
            database.ref('teamO').set({
                total: 0,
                bets: 0
            });
            
            database.ref('bets').remove();
            
            database.ref('gameState').set({
                ended: false,
                winner: null,
                winAmount: 0
            });
        }

        // Pul formati
        function formatCurrency(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // O'yinchi chiqayotganda
        window.addEventListener('beforeunload', () => {
            if (playerId) {
                database.ref('players/' + playerId).update({
                    online: false,
                    lastActive: Date.now()
                });
            }
        });

        // Dastlabki timer sozlamalari
        window.addEventListener('load', () => {
            database.ref('timer').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    database.ref('timer').set({
                        currentTime: BETTING_TIME,
                        isBettingPhase: true,
                        isRunning: false,
                        lastUpdated: Date.now()
                    });
                }
            });
        });
    </script>
</body>
</html>
